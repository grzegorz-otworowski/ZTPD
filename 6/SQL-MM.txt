-- ZAD 1A

S lpad('-',2*(level-1),'|-') || t.owner||'.'||t.type_name||' (FINAL:'||t.final||
', INSTANTIABLE:'||t.instantiable||', ATTRIBUTES:'||t.attributes||', METHODS:'||t.methods||')'
from all_types t
start with t.type_name = 'ST_GEOMETRY'
connect by prior t.type_name = t.supertype_name
    and prior t.owner = t.owner;

-- ZAD 1B

select distinct m.method_name
from all_type_methods m
where m.type_name like 'ST_POLYGON'
and m.owner = 'MDSYS'
order by 1;

-- ZAD 1C

CREATE TABLE MYST_MAJOR_CITIES (
    FIPS_CNTRY VARCHAR2(2),
    CITY_NAME VARCHAR2(40),
    STGEOM ST_POINT
);

-- ZAD 1D

INSERT INTO MYST_MAJOR_CITIES 
(FIPS_CNTRY, CITY_NAME, STGEOM)
SELECT FIPS_CNTRY, CITY_NAME, TREAT(ST_POINT.FROM_SDO_GEOM(GEOM) AS ST_POINT)
FROM MAJOR_CITIES;

-- ZAD 2A

INSERT INTO MYST_MAJOR_CITIES
VALUES('PL', 'Szczyrek', TREAT(ST_POINT.FROM_WKT('POINT(19.036107 49.718655)', 8307) AS ST_POINT));

-- ZAD 2B

SELECT NAME, TREAT(ST_POINT.FROM_SDO_GEOM(GEOM) AS ST_GEOMETRY).GET_WKT() AS WKT
FROM RIVERS;

-- ZAD 2C

SELECT SDO_UTIL.TO_GMLGEOMETRY(ST_POINT.GET_SDO_GEOM(STGEOM)) GML
FROM MYST_MAJOR_CITIES
WHERE CITY_NAME = 'Szczyrek';

-- ZAD 3C

CREATE TABLE MYST_COUNTRY_BOUNDARIES(
    FIPS_CNTRY VARCHAR2(2),
    CNTRY_NAME VARCHAR2(40),
    STGEOM ST_MULTIPOLYGON
);

-- ZAD 3B

INSERT INTO MYST_COUNTRY_BOUNDARIES
(FIPS_CNTRY, CNTRY_NAME, STGEOM)
SELECT FIPS_CNTRY, CNTRY_NAME, ST_MULTIPOLYGON(GEOM)
FROM COUNTRY_BOUNDARIES;

-- ZAD 3C

SELECT CB.STGEOM.ST_GEOMETRYTYPE() AS TYP_OBIEKTU, COUNT(*) AS ILE
FROM MYST_COUNTRY_BOUNDARIES CB
GROUP BY CB.STGEOM.ST_GEOMETRYTYPE();

-- ZAD 3D

SELECT CB.STGEOM.ST_ISSIMPLE() 
FROM MYST_COUNTRY_BOUNDARIES CB;

-- ZAD 4A

SELECT CB.CNTRY_NAME, COUNT(*)
FROM MYST_COUNTRY_BOUNDARIES CB, MYST_MAJOR_CITIES MC
WHERE MC.STGEOM.ST_WITHIN(CB.STGEOM) = 1
GROUP BY CB.CNTRY_NAME; 

-- ZAD 4B

SELECT MC.CNTRY_NAME AS A_NAME, CZ.CNTRY_NAME AS B_NAME
FROM MYST_COUNTRY_BOUNDARIES MC, MYST_COUNTRY_BOUNDARIES CZ
WHERE MC.STGEOM.ST_TOUCHES(CZ.STGEOM) = 1 AND CZ.CNTRY_NAME = 'Czech Republic'; 

-- ZAD 4C

SELECT DISTINCT CZ.CNTRY_NAME, R.NAME
FROM MYST_COUNTRY_BOUNDARIES CZ, RIVERS R
WHERE CZ.CNTRY_NAME = 'Czech Republic' AND ST_LINESTRING(R.GEOM).ST_INTERSECTS(CZ.STGEOM) = 1;

-- ZAD 4D

SELECT ROUND(TREAT(CZ.STGEOM.ST_UNION(S.STGEOM) AS ST_POLYGON).ST_AREA(), -2) AS POWIERZCHNIA
FROM MYST_COUNTRY_BOUNDARIES CZ, MYST_COUNTRY_BOUNDARIES S
WHERE CZ.CNTRY_NAME = 'Czech Republic' AND S.CNTRY_NAME = 'Slovakia';

-- ZAD 4E

SELECT H.STGEOM AS OBIEKT, H.STGEOM.ST_DIFFERENCE(ST_GEOMETRY(W.GEOM)).ST_GEOMETRYTYPE() AS WEGRY_BEZ
FROM MYST_COUNTRY_BOUNDARIES H, WATER_BODIES W
WHERE H.CNTRY_NAME = 'Hungary' AND W.NAME = 'Balaton';

-- ZAD 5A

EXPLAIN PLAN FOR
    SELECT PL.CNTRY_NAME, COUNT(*)
    FROM MYST_COUNTRY_BOUNDARIES PL, MYST_MAJOR_CITIES MC
    WHERE SDO_WITHIN_DISTANCE(MC.STGEOM, PL.STGEOM, 'distance=100 unit=km') = 'TRUE'
        AND PL.CNTRY_NAME = 'Poland'
    GROUP BY PL.CNTRY_NAME; 
    
SELECT PLAN_TABLE_OUTPUT FROM TABLE(DBMS_XPLAN.DISPLAY());

-- ZAD 5B

INSERT INTO USER_SDO_GEOM_METADATA
SELECT 'MYST_MAJOR_CITIES', 'STGEOM', T.DIMINFO, T.SRID
FROM ALL_SDO_GEOM_METADATA T
WHERE T.TABLE_NAME = 'MAJOR_CITIES';

INSERT INTO USER_SDO_GEOM_METADATA
SELECT 'MYST_COUNTRY_BOUNDARIES', 'STGEOM', T.DIMINFO, T.SRID
FROM ALL_SDO_GEOM_METADATA T
WHERE T.TABLE_NAME = 'COUNTRY_BOUNDARIES';

-- ZAD 5C

CREATE INDEX MYST_MAJOR_CITIES_IDX ON
 MYST_MAJOR_CITIES(STGEOM)
INDEXTYPE IS MDSYS.SPATIAL_INDEX;

CREATE INDEX MYST_COUNTRY_BOUNDARIES_IDX ON
 MYST_COUNTRY_BOUNDARIES(STGEOM)
INDEXTYPE IS MDSYS.SPATIAL_INDEX;

-- ZAD 5D

EXPLAIN PLAN FOR
    SELECT PL.CNTRY_NAME, COUNT(*)
    FROM MYST_COUNTRY_BOUNDARIES PL, MYST_MAJOR_CITIES MC
    WHERE SDO_WITHIN_DISTANCE(MC.STGEOM, PL.STGEOM, 'distance=100 unit=km') = 'TRUE'
        AND PL.CNTRY_NAME = 'Poland'
    GROUP BY PL.CNTRY_NAME; 
    
SELECT PLAN_TABLE_OUTPUT FROM TABLE(DBMS_XPLAN.DISPLAY());